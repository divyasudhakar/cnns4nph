import sys
import nibabel as nib
import os
import numpy as np

def main():
# This file will set up the necessary data files to launch the initializer file
# This file is meant to pre-process images
# Dependencies
# - Needs casesliceindices.csv
# - Needs cwd/slices and cwd/slices/Validation (note cap) to be valid

    def subsectimage (f, img_data,start,stop,isaxial): 
    #function will take an image, slice it, and save it to current directory
        if isaxial:
            for i in range(start,stop+1):
                slice = img_data[: , i, :] # the ith slice, x<=i<=y
                filesave = f[0:5] + '-' + str(i) + '.dat'
                slice.dump(filesave)
        else:
            for i in range(start,stop+1):
                slice = img_data[:,:,i]
                filesave = f[0:5]+'-'+str(i)+'.dat'
                slice.dump(filesave)


    def reshapelabels(labels):
    #Reshape labels into mx3 matrix
    #1 = NPH, 2 = AD, 3 = Normal Control
    #1 = 100, 2 = 010, 3 = 001
        newlabels = np.empty((0,3))
        for i in labels:
            if i == 1:
                newlabels = np.vstack((newlabels,[1,0,0]))
            if i == 2:
                newlabels = np.vstack((newlabels,[0,1,0]))
            if i == 3:
                newlabels = np.vstack((newlabels,[0,0,1]))
        return newlabels

    def caselookup(casenums):
        casepairs = np.empty((0,1))
        for i in casenums: #for every case in casenums
            pairind = np.where(casekey[:,0]==i)[0]#lookup index of i-th case w/in casekey
            # pairind[0] holds index within casekey
            pair = casekey[pairind,1]
            casepairs= np.vstack((casepairs,pair))   
        return casepairs

    numpixels = 256 * 256
    isaxial = True
    isnarrowaxial = True
    fstart = -1
    fstop = -1

    print 'Initializer started' #debugging
    print 'This program preprocesses images'
    print 'This program will process axial slices: ' + str(isaxial)
    print 'This program will process narrow axial slices: ' +str(isnarrowaxial)
    cwd = os.getcwd()
    slicesfilepath = cwd + "/slices"
    validationfilepath = slicesfilepath + "/Validation"


    os.chdir(slicesfilepath)
    
    if 'validationnums.dat' in os.listdir(slicesfilepath):
        print 'Prior files available'

        
        #Whatever command
    else:
        print 'slicing images'
        os.chdir(cwd)
        caseindices = np.genfromtxt('casesliceindices.csv', delimiter=',') #case 1 is indexed as 0, etc
        os.chdir(slicesfilepath)
        for f in os.listdir(slicesfilepath):
            if f.find('.nii') != -1: #If it's a .nii file
                epi_img = nib.load(f)
                epi_img_data = epi_img.get_data()
                if epi_img_data.shape[0] * epi_img_data.shape[1] == numpixels:
                    findex = int(f[1:5])-1
                    if isaxial and isnarrowaxial:                    
                        fstart = caseindices[findex,1]
                        fstop = caseindices[findex,2]
                    elif isaxial == True and isnarrowaxial == False:
                        fstart = caseindices[findex,0]
                        fstop = caseindices[findex,3]
                    else:
                        fstart = caseindices[findex,4]
                        fstop = caseindices[findex,5]
                    fstart = int(fstart)
                    fstop = int(fstop)
                    subsectimage(f,epi_img_data,fstart,fstop, isaxial)


        os.chdir(validationfilepath)
        for f in os.listdir(validationfilepath):
            if f.find('.nii') != -1: #If it's a .nii file
                epi_img = nib.load(f)
                epi_img_data = epi_img.get_data()
                if epi_img_data.shape[0] * epi_img_data.shape[1] == numpixels:
                    findex = int(f[1:5])-1
                    if isaxial and isnarrowaxial:                    
                        fstart = caseindices[findex,1]
                        fstop = caseindices[findex,2]
                    elif isaxial == True and isnarrowaxial == False:
                        fstart = caseindices[findex,0]
                        fstop = caseindices[findex,3]
                    else:
                        fstart = caseindices[findex,4]
                        fstop = caseindices[findex,5]
                    fstart = int(fstart)
                    fstop = int(fstop)
                    subsectimage(f,epi_img_data,fstart,fstop, isaxial)

    
    # This process will flatten all '.dat' files into one matrix and track labels

    # initializations, constants
        flatcasesmatrix = np.empty((0,numpixels))
        flatvalidationmatrix = np.empty((0,numpixels))
        casenums = np.empty((0,1))
        validationnums = np.empty((0,1))
        counter = 0

        os.chdir(slicesfilepath)
        for i in os.listdir(slicesfilepath):
            if '.dat' in i:
                boxdata = np.load(i) # load the data
                if boxdata.shape[0]*boxdata.shape[1]==numpixels:
                    flatdata = boxdata.flatten() # flatten the data
                    flatdata.shape = (1,numpixels) #make the data horizontal
                    flatcasesmatrix = np.vstack((flatcasesmatrix,flatdata)) # flatten data
                    casenums = np.vstack((casenums,int(str(i[1:5])))) # store casenumber
                    counter = counter +1
                '''if counter > 25: break #for debugging'''

        os.chdir(validationfilepath)
        for i in os.listdir(validationfilepath):
            if '.dat' in i:
                boxdata = np.load(i) # load the data
                if boxdata.shape[0]*boxdata.shape[1]==numpixels:
                    flatdata = boxdata.flatten() # flatten the data
                    flatdata.shape = (1,numpixels) #make the data horizontal
                    flatvalidationmatrix = np.vstack((flatvalidationmatrix,flatdata))
                    validationnums = np.vstack((validationnums,int(str(i[1:5]))))
                    counter = counter +1


        # Reshapes labels
        casekeyfilepath =cwd
        os.chdir(casekeyfilepath)
        casekey = np.genfromtxt('casekey.csv',delimiter=',')
        labels = caselookup(casenums) #returns list of labels 
        validationlabels = caselookup(validationnums)
        labels = reshapelabels(labels)
        validationlabels = reshapelabels(validationlabels)


        # Saves the files that get used by tflauncher      
        os.chdir(slicesfilepath)
        flatcasesmatrix.dump('flatcasesmatrix.dat')
        flatvalidationmatrix.dump('flatvalidationmatrix.dat')
        casenums.dump('casenums.dat')
        validationlabels.dump('validationlabels.dat')
        labels.dump('labels.dat')

        print 'Output files created and saved'



    # Debugging code, will probably get killed


if __name__ == '__main__':
	main()
